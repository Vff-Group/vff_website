{% extends "common/full_page_base.html" %}
{% load static %}
{% block title%}
{% if data %}
Update Order Details
{% else %}
Add New Order Details
{% endif %}
{% endblock title %}
{% block content %}

<div class="main-content">
   
    
    <!-- Page content -->
    <div class="container-fluid mt-2 mb-4">
       
        <div class="card card-profile shadow mb-4">
        <div class="card-body">
    <form method="post" >
        {% csrf_token %}
      <h6 class="heading-small text-muted mb-4">Order Information</h6>
      <div class="pl-lg-4">
        <div class="row">
          <div class="col-lg-6">
            <div class="form-group">
              <label class="form-control-label" for="input-fullname">Full Name</label>
              <input type="text" id="input-fullname" class="form-control form-control-alternative" placeholder="Enter full name" name="fullname" autocomplete="off" value="{{ data.fullname|default:'' }}"  required>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="form-group">
              <label class="form-control-label" for="input-primary-contact">Primary Contact Number</label>
              <input type="number" id="input-primary-contact" class="form-control form-control-alternative" placeholder="Enter primary contact number" name="primaryno" value="{{ data.primaryno|default:'' }}"  required>
            </div>
          </div>
          
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="form-group">
                <label for="date-of-birth" class="form-control-label">Date of Birth</label>
                <input class="form-control form-control-alternative" type="date"  id="date-of-birth" name="dateofbirth" value="{{ data.dateofbirth|date:'Y-m-d' }}" required>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="form-group">
              <label class="form-control-label" for="input-age">Age</label>
              <input type="number" id="input-age" class="form-control form-control-alternative" placeholder="Enter Age Here" name="age" value="{{ data.age|default:'' }}" >
            </div>
          </div>
          <div class="col-lg-4">
            <div class="form-group">
              <label class="form-control-label" for="input-gender">Gender</label>
              <select class="form-control form-control-alternative" id="input-gender" name="gender">
                <option value="Male"  {% if data.gender == 'Male' %}selected{% endif %}>Male</option>
                <option value="Female" {% if data.gender == 'Female' %}selected{% endif %}>Female</option>
                <option value="Other" {% if data.gender == 'Other' %}selected{% endif %}>Other</option>
              </select>
            </div>
          </div>
          
          

        </div>
      </div>
      <hr class="my-4" />
      <!-- Address -->
      <h6 class="heading-small text-muted mb-4">Contact information</h6>
      <div class="pl-lg-4">
        <div class="row">
          <div class="col-lg-6">
            <div class="form-group">
              <label class="form-control-label" for="input-address">Address</label>
              <input id="input-address" class="form-control form-control-alternative" placeholder="Home Address"  type="text" name="fulladdress" value="{{ data.fulladdress|default:'' }}"  required>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-group">
              <label class="form-control-label" for="input-country">Postal code</label>
              <input type="number" id="input-postal-code" class="form-control form-control-alternative" placeholder="Postal code" name="pincode" value="{{ data.pincode|default:'' }}"  required>
            </div>
          </div>

          <div class="col-lg-3">
            <div class="form-group">
              <label class="form-control-label" for="input-landmark">Nearest Landmark</label>
              <input id="input-landmark" class="form-control form-control-alternative" placeholder="Nearest landmark like car showroom,etc"  type="text" name="landmark" value="{{ data.landmark|default:'' }}"  required>
            </div>
          </div>
        </div>
        
       
          
      </div>
      <hr class="my-4" />
      <!-- Description -->
      <h6 class="heading-small text-muted mb-4">Any Query</h6>
      <div class="pl-lg-4">
        <div class="form-group">
          <label>Questions ?</label>
          <textarea rows="4" class="form-control form-control-alternative" placeholder="write a few words if required ..." name="questions" >{{ data.questions|default:'' }}</textarea>
        </div>
      </div>

      <div class="row justify-content-end p-4 mt--1">
        <div class="col-lg-2">
        {% if data %}
        <button type="submit" class="btn btn-primary my-4">Update Order </button>
        {% else %}
        <button type="submit" class="btn btn-primary my-4">Add New Order</button>
        {% endif %}
    </div>
      </div>
    </form>
  </div>
</div>
</div>
</div>


<script>
    //Calculate Age when dob is selected
document.addEventListener('DOMContentLoaded', function () {
    // Get references to the date of birth and age input fields
    const dateOfBirthInput = document.getElementById('date-of-birth');
    const ageInput = document.getElementById('input-age');

    // Attach an event listener to the date of birth input field
    dateOfBirthInput.addEventListener('input', function () {
        // Get the selected date of birth
        const dateOfBirth = new Date(dateOfBirthInput.value);

        // Calculate the age
        const today = new Date();
        const age = today.getFullYear() - dateOfBirth.getFullYear();

        // Update the age input field with the calculated age
        ageInput.value = age;
    });
});
</script>


<script>


  /* $(document).ready(function() {
      $('#input-section').select2();
    }); 
    */

    // Add an event listener to handle increment
   /* $("#subCategoryTable").on("click", ".increment", function() {
var quantityInput = $(this).closest("tr").find(".quantity");
var sub_cat_name = $(this).closest("tr").find("#sub_cat_name").text();
var sub_catid = $(this).closest("tr").find("#sub_catid").text();
console.log("Selected_sub_cat_name::"+sub_cat_name);
console.log("Selected_sub_catid::"+sub_catid);
var currentQuantity = parseInt(quantityInput.text());
quantityInput.text(currentQuantity + 1);
});

// Add an event listener to handle decrement
$("#subCategoryTable").on("click", ".decrement", function() {
var quantityInput = $(this).closest("tr").find(".quantity");

var currentQuantity = parseInt(quantityInput.text());
if (currentQuantity > 0) {
  quantityInput.text(currentQuantity - 1);
}
});
*/

// Add an event listener to handle increment


// Add an event listener to handle both increment and decrement
/*$("#subCategoryTable").on("click", ".increment, .decrement", function() {
var row = $(this).closest("tr");
var sub_cat_name = $(this).closest("tr").find("#sub_cat_name").text();
var subcatid = $(this).closest("tr").find("#sub_catid").text();
var subCategory = $(this).closest("tr").find("#subCategory").text();
var subCategory = $(this).closest("tr").find("#subCategory").text();
console.log("Selected_sub_cat_name::"+sub_cat_name);
console.log("Selected_sub_catid::"+sub_catid);



// Access the properties of subCategory
var sub_cat_name = subCategory.sub_cat_name;
var sub_cat_img = subCategory.sub_cat_img;
var cost = subCategory.cost;
var type = subCategory.type;
//var section_type = subCategory.section_type;

var quantityInput = row.find(".quantity");
var currentQuantity = parseInt(quantityInput.text());

if ($(this).hasClass("increment")) {
  // Handle increment logic
  quantityInput.text(currentQuantity + 1);
} else if ($(this).hasClass("decrement") && currentQuantity > 0) {
  // Handle decrement logic
  quantityInput.text(currentQuantity - 1);
}

// Update the selectedItems array based on the quantity
var selectedItemIndex = selectedItems.findIndex(item => item.subcatid === subcatid);

if (selectedItemIndex !== -1) {
  if (currentQuantity > 0) {
      // Update the existing item
      selectedItems[selectedItemIndex].item_quantity = currentQuantity;
      selectedItems[selectedItemIndex].cost = cost * currentQuantity;
  } else {
      // If the item count is zero, remove the item
      selectedItems.splice(selectedItemIndex, 1);
  }
} else {
  if (currentQuantity > 0) {
      // Add the new item
      selectedItems.push({
          subCategoryName: sub_cat_name,
          item_quantity: currentQuantity,
          sub_cat_name: sub_cat_name,
          actual_cost: cost,
          cost: cost * currentQuantity,
          type_of: type,
          sub_cat_id: subcatid,
          sub_cat_img: sub_cat_img,
          //section_type: section_type
      });
  }
}

console.log("selectedItems::"+selectedItems)

// You can now use the updated 'selectedItems' array as needed.
});
*/



var selectedItems = [];
// Add event listeners to handle both increment and decrement
/*$("#subCategoryTable").on("click", ".increment, .decrement", function() {
var row = $(this).closest("tr");
var sub_cat_name = $(this).closest("tr").find("#sub_cat_name").text();
var subcatid = $(this).closest("tr").find("#sub_catid").text();

var quantityInput = row.find(".quantity");
var currentQuantity = parseInt(quantityInput.text());

//console.log("Selected_sub_cat_name::"+sub_cat_name);
//console.log("Selected_sub_catid::"+sub_catid);

// Create an object to represent the selected item with quantity
var selectedItem = {
  sub_cat_name: sub_cat_name,
  subcatid: subcatid,
  quantity:currentQuantity
   // Include the quantity in the object
};




if ($(this).hasClass("increment")) {
  // Handle increment logic
  quantityInput.text(currentQuantity + 1);
  //Update the quantity in the selected item
  selectedItem.quantity = currentQuantity + 1;
// Push the selected item to the list
  selectedItems.push(selectedItem);
} else if ($(this).hasClass("decrement") && currentQuantity > 0) {
  // Handle decrement logic
  quantityInput.text(currentQuantity - 1);
    // Update the quantity in the selected item
    selectedItem.quantity = currentQuantity - 1;
  // Find and remove the item from the selectedItems list
  var indexToRemove = selectedItems.findIndex(item => item.subcatid === subcatid);
  if (indexToRemove !== -1) {
      selectedItems.splice(indexToRemove, 1);
  }
}

// Log the selected item
//console.log("Selected_sub_cat_name::" + sub_cat_name);
//console.log("Selected_subcatid::" + subcatid);
//console.log("Selected_quantity::" + currentQuantity);
console.log('----------------');
console.log('selectedItem::'+selectedItem.quantity+"-"+selectedItem.sub_cat_name);
console.log('----------------');
console.log("selectedItems:"+selectedItems)


});
*/

var sub_cat_img = $(this).closest("tr").find("#sub_cat_img").text();
var actual_cost = $(this).closest("tr").find("#cost").text();
var type = $(this).closest("tr").find("#type").text();
var selectedItems = [];
//Add To Cart Button
$("#add_to_cart").on("click",function(){
jsonItems = JSON.stringify(selectedItems);
console.log("Item Details::"+jsonItems)
})

$("#subCategoryTable").on("click", ".increment, .decrement", function() {
var row = $(this).closest("tr");
var sub_cat_name = $(this).closest("tr").find("#sub_cat_name").text();
var subcatid = $(this).closest("tr").find("#sub_catid").text();
var sub_cat_img = $(this).closest("tr").find("#sub_cat_img").text();
var actual_cost = $(this).closest("tr").find("#cost").text();
var type = $(this).closest("tr").find("#type").text();



var quantityInput = row.find(".quantity");
var currentQuantity = parseInt(quantityInput.text());

// Find the existing item in the selectedItems list with the same subcatid
var selectedItemIndex = selectedItems.findIndex(item => item.subcatid === subcatid);

if ($(this).hasClass("increment")) {
  // Handle increment logic
  quantityInput.text(currentQuantity + 1);

  if (selectedItemIndex !== -1) {
      // Update the quantity in the selected item
      selectedItems[selectedItemIndex].item_quantity = currentQuantity + 1;
  } else {
      // Create a new object and push it to the list
      var newItem = {
          sub_cat_name: sub_cat_name,
          subcatid: subcatid,
          item_quantity: currentQuantity + 1,
          actual_cost: actual_cost,
          cost: 45 * (currentQuantity + 1),
          type_of: type, 
          sub_cat_id: subcatid,
          sub_cat_img: sub, 
          section_type: 'All'
      };
     /* var newItem = {
          subCategoryName: sub_cat_name,
          item_quantity: currentQuantity + 1,
          sub_cat_name: sub_cat_name,
          actual_cost: 45, // Replace 'item.cost' with the actual value
          cost: 45 * (currentQuantity + 1),
          type_of: 'Kgs', // Replace 'item.typeOf' with the actual value
          sub_cat_id: subcatid,
          sub_cat_img: 'NA', // Replace 'item.subCategoryImage' with the actual value
          section_type: 'All'
      };*/
      selectedItems.push(newItem);
  }
} else if ($(this).hasClass("decrement") && currentQuantity > 0) {
  // Handle decrement logic
  quantityInput.text(currentQuantity - 1);

  if (selectedItemIndex !== -1) {
      // Update the quantity in the selected item
      selectedItems[selectedItemIndex].item_quantity = currentQuantity - 1;
      //selectedItems[selectedItemIndex].item_quantity = currentQuantity - 1;
      //selectedItems[selectedItemIndex].cost = selectedItems[selectedItemIndex].actual_cost * (currentQuantity - 1);
      // Remove the item from the list if the quantity is 0
      if (currentQuantity - 1 === 0) {
          selectedItems.splice(selectedItemIndex, 1);
      }
  }
}

// Remove the item from the JSON object if it's not in the selectedItems list
jsonItems = selectedItems.filter(item => item.item_quantity > 0);

// Log the selected item
console.log('----------------');
if (selectedItemIndex !== -1) {
  console.log('selectedItem::' + selectedItems[selectedItemIndex].currentQuantity + "-" + selectedItems[selectedItemIndex].sub_cat_name);
}
console.log('----------------');
console.log("selectedItems: " + JSON.stringify(selectedItems));
console.log('----------------');
console.log('jsonItems: ' + JSON.stringify(jsonItems));

});









var dataCat = {}

  function loadSubCategories(categorySelect) {
      var selectedCategory = $(categorySelect).val();
      var cat_id = $(categorySelect).find(":selected").data("catids");
      console.log('CatID::'+cat_id)
      var sectionSelect = $('#input-section');
      var section_column = $('#section_col');
      var price_column = $('#price_col');
      
      //To Hide and 
      
      var only_dry_clean_column = $('#other-then-dry-clean');
      var price_column = $('#price_col');
      //var subCategorySelect = $('#input-subcategory');
      var subCategoryTable = $('#subCategoryTable tbody');
      var priceSelect = $('#input-price');

      //Extra Headers
     // var costTh = $("<th class='text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2 w-25'>Cost</th>");
      //var emptyTh = $("<th class='text-secondary opacity-7'></th>");

      console.log('selectedCategory::'+selectedCategory)
      if (selectedCategory == "DRY CLEAN"){
          //Load Sections Here 
          //$("#subCategoryTable").find("thead tr").remove(costTh);
          //$("#subCategoryTable").find("thead tr").append(costTh);
          //$("#subCategoryTable").find("thead tr").append(emptyTh);

          subCategoryTable.empty()

          section_column.show();
          price_column.hide();
          only_dry_clean_column.hide(); //to not show KGS Add Quantity
         // subCategorySelect.empty();
          //subCategorySelect.append('<option disabled selected>Choose Sub Category</option>');
          $.get(`/admin_dashboard/load_sub_categories/${cat_id}`, function(data) {
             sectionSelect.empty();
              sectionSelect.append('<option disabled selected>Choose Section</option>');
      console.log('sectionSelect::'+sectionSelect)
              $.each(data.section_data, function(index, subSection) {
                  sectionSelect.append($('<option>', {
                      value: subSection.section_name,
                      text: subSection.section_name
                  }));
              });
              
          });
    
      }else{
         // $("#subCategoryTable").find("thead tr").append(emptyTh);
          //$("#subCategoryTable").find("thead tr").remove(costTh);
          section_column.hide();
          only_dry_clean_column.show();
          price_column.show();
      $.get(`/admin_dashboard/load_section_type_sub_categories/All`, function(data) {
          /*subCategorySelect.empty();
          subCategorySelect.append('<option disabled selected>Choose Sub Category</option>');
  
          $.each(data.sub_categories, function(index, subCategory) {
              subCategorySelect.append($('<option>', {
                  value: subCategory.subcatid,
                  text: subCategory.sub_cat_name
              }));
          });*/

          

subCategoryTable.empty(); // Clear any existing rows
console.log('subCategoryTable:'+subCategoryTable);
dataCat = data.sub_categories
$.each(data.sub_categories, function(index, subCategory) {



var newRow = $("<tr>");
  newRow.append("<td> <div class='d-flex px-2 py-1'> <div> <div id='sub_catid' style='display:none;'>"+subCategory.subcatid+"</div>"+
  "<td> <div class='d-flex px-2 py-1'> <div> <div id='sub_cat_img' style='display:none;'>"+subCategory.sub_cat_img+"</div>"+
  "<td> <div class='d-flex px-2 py-1'> <div> <div id='cost' style='display:none;'>"+subCategory.cost+"</div>"+
  "<td> <div class='d-flex px-2 py-1'> <div> <div id='type' style='display:none;'>"+subCategory.type+"</div>"+
      " <div id='selectedCategory' style='display:none;'>"+selectedCategory+"</div> <div id='subCategory' style='display:none;'>"+subCategory+"</div> <img src="+subCategory.sub_cat_img+" class='avatar avatar-sm me-3' alt='user1'> </div> <div class='d-flex flex-column justify-content-center'> <h6 class='mb-0 text-sm' id='sub_cat_name'>"+subCategory.sub_cat_name +"</h6> </div> </div> </td>")
//newRow.append("<td> <p class=\"text-xs font-weight-bold mb-0\">" + subCategory.sub_cat_name + "</p></td>");
/* newRow.append("<td><input type='number' value='0' min='0'></td>"); 
newRow.append("<td>  <div class=\"d-flex px-2 py-1\"> <p class=\"mb-0 text-xxs text-center\"> " + subCategory.cost +'/ '+subCategory.type + " </p></div></td>");
newRow.append("<td>  <p class=\"text-xxs font-weight-bold mb-0\">" + ${subCategory.type} + "</p></td>");
newRow.append("<td><button class='btn btn-danger btn-sm ms-1 increment'>+</button><input class='m-2' type='number' value='0' min='0'><button class='btn btn-success btn-sm ms-1 decrement'>-</button></td>");*/
newRow.append("<td style=\"vertical-align: middle; \">  <div class=\"btn-group btn-group-sm mt-2\" style=\"width: 5px; display: flex; align-items: center;\" role=\"group\" aria-label=\"Basic mixed styles example\"> <button type=\"button\" class=\"btn btn-danger btn-sm decrement\" style=\"width: 10px;\" >-</button><button type=\"button\" class=\"btn btn-sm quantity\" style=\"width: 10px;\" >0</button><button type=\"button\" class=\"btn btn-success btn-sm increment\" style=\"width: 10px;\" >+</button> </td>")

subCategoryTable.append(newRow);

});

      });
      console.log('While Loading CatID::'+cat_id)
      $.get(`/admin_dashboard/load_other_category_wise_details/${cat_id}`, function(data) {
          console.log("priceCategory::"+data.other_category_data);
          priceCategory = data.other_category_data;

          priceSelect.empty();
          priceSelect.append('<option disabled selected>Choose Service Type</option>');
          // Access and use the properties of the priceCategory object here
          // Regular Price
priceSelect.append($('<optgroup>', {
  label: 'Regular Price',
}));
priceSelect.append($('<option>', {
  value: `${priceCategory.regular_price} [${priceCategory.regular_price_type}] `,
  text: `${priceCategory.regular_price} [${priceCategory.regular_price_type}] `,
}));

// Express Price
priceSelect.append($('<optgroup>', {
  label: 'Express Price',
}));
priceSelect.append($('<option>', {
  value: `${priceCategory.express_price} [${priceCategory.express_price_type}] `,
  text: `${priceCategory.express_price} [${priceCategory.express_price_type}] `,
}));

// Offer Price
priceSelect.append($('<optgroup>', {
  label: 'Offer Price',
}));
priceSelect.append($('<option>', {
  value: `${priceCategory.offer_price} [${priceCategory.offer_price_type}] `,
  text: `${priceCategory.offer_price} [${priceCategory.offer_price_type}] `,
}));

         
  
 
          
      
      });


  }
  }

  function loadSubCategoriesBySection(sectionTypeSelect) {
      var section_type = $(sectionTypeSelect).val();
      var section_id = $(sectionTypeSelect).find(":selected").data("section_id");
      console.log('section_id::'+section_id)
      console.log('section_type::'+section_type)
      var sectionSelect = $('#input-section');
      var subCategoryTable = $('#subCategoryTable tbody');
      //var subCategorySelect = $('#input-subcategory');
      
      
      $.get(`/admin_dashboard/load_section_type_sub_categories/${section_type}`, function(data) {
          

subCategoryTable.empty(); // Clear any existing rows

$.each(data.sub_categories, function(index, subCategory) {
var newRow = $("<tr>");
  newRow.append("<td> <div class='d-flex px-2 py-1'> <div> <img src="+subCategory.sub_cat_img+" class='avatar avatar-sm me-3' alt='user1'> </div> <div class='d-flex flex-column justify-content-center'> <h6 class='mb-0 text-sm'>"+subCategory.sub_cat_name+"</h6> <p class='text-xs text-secondary mb-0'>"+subCategory.cost +'/ '+subCategory.type+"</p> </div> </div> </td>")

//newRow.append("<td>  <div class=\"d-flex px-2 py-1\"> <p class=\"mb-0 text-xxs text-center\"> " + subCategory.cost +'/ '+subCategory.type + " </p></div></td>");
/* newRow.append("<td><input type='number' value='0' min='0'></td>"); 
newRow.append("<td>  <p class=\"text-xxs font-weight-bold mb-0\">" + ${subCategory.type} + "</p></td>");
newRow.append("<td><button class='btn btn-danger btn-sm ms-1 increment'>+</button><input class='m-2' type='number' value='0' min='0'><button class='btn btn-success btn-sm ms-1 decrement'>-</button></td>");*/
newRow.append("<td style=\"vertical-align: middle; \">  <div class=\"btn-group btn-group-sm mt-2\" style=\"width: 5px; display: flex; align-items: center;\" role=\"group\" aria-label=\"Basic mixed styles example\"> <button type=\"button\" class=\"btn btn-danger btn-sm decrement\" style=\"width: 10px;\" >-</button><button type=\"button\" class=\"btn btn-sm quantity\" style=\"width: 10px;\" >0</button><button type=\"button\" class=\"btn btn-success btn-sm increment\" style=\"width: 10px;\" >+</button> </td>")

subCategoryTable.append(newRow);
});
          /*subCategorySelect.empty();
          subCategorySelect.append('<option disabled selected>Choose Sub Category</option>');
  
          $.each(data.sub_categories, function(index, subCategory) {
              subCategorySelect.append($('<option>', {
                  value: subCategory.subcatid,
                  text: subCategory.sub_cat_name
              }));
          });*/

      });

  
  }

</script>
{% endblock %}
