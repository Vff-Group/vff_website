{% extends "common/base.html" %}
{% load static %}
{% block title %}Order Report{% endblock title%}
{% block content %}

<div class="container-fluid py-4">
    <div class="row">
      <div class="col-lg-12">
        <div class="row">
          <div class="col-12">
            <div class="card mb-4">
              <div class="card-header pb-0">
                <h6>Order Report</h6>
                <form action="get" id="orderReportForm">
                  {% csrf_token %}
                <div class="row">
                  <div class="col-4">
                    <div class="col-lg-10">
                      <div class="form-group">
                        <label
                          for="start-date"
                          class="form-control-label text-secondary"
                          >Start Date</label
                        >
                        <input
                          class="form-control form-control-alternative"
                          type="date"
                          id="start-date"
                          name="startdate"
                          value=""
                          required
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="col-lg-10">
                      <div class="form-group">
                        <label
                          for="end-date"
                          class="form-control-label text-secondary"
                          >End Date</label
                        >
                        <input
                          class="form-control form-control-alternative"
                          type="date"
                          id="end-date"
                          name="dateofexpense"
                          value=""
                          required
                        />
                      </div>
                    </div>
                  </div>

                  <div class="col-4">
                    <div class="col-lg-10">
                      <div class="form-group">
                        <label
                        for="input-order_type"
                        class="form-control-label text-secondary"
                        >Order Type</label
                      >
                        <select class="form-control form-control-alternative" id="input-order_type" name="order_type" required>
                          <option value="All Orders"  >All Orders</option>
                          <option value="Processing" >Processing</option>
                          <option value="Payment Done" >Payment Done</option>
                          <option value="Out for Delivery" >Out for Delivery</option>
                          <option value="Completed" >Completed</option>
                          <option value="Others" >Others</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
              </div>
              <!-- Action Buttons  -->

              <!-- Action Buttons End  -->
              <div class="card-body px-0 pt-0 pb-2 mt-2">
                <div class="table-responsive p-0">
                  <table class="table align-items-center mb-0"  id="orderTable" >
                    <thead>
                      <tr>
                        <th
                          class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                        >
                          Date
                        </th>
                        <th
                          class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                        >
                          Order ID
                        </th>
                        <th
                          class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                        >
                          Customer
                        </th>
                        <th
                          class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                        >
                          Order Amount
                        </th>
                        <th
                          class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                        >
                          Status
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer px-4 pt-0 pb-2 mt-2">
                <div class="row">
                  <div class="col-4">
                    <small class="mb-2 text-dark total-orders">Total Order: 0</small>
                  </div>
                  <div class="col-4">
                    <small class="text-dark total-amount">Total Order Amount: Rs.0/-</small>
                  </div>
                  <div class="col-4">
                    <button class="btn btn-success" id="download">Download </button>
                    <button class="btn btn-warning" id="print">Print </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>

<!-- ... your existing HTML code ... -->

<script>
  // Get the CSRF token from the cookie
function getCSRFToken() {
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith("csrftoken=")) {
          return cookie.substring("csrftoken=".length, cookie.length);
      }
  }
  return null;
}

var data = [];
  $(document).ready(function() {
    // Function to handle the AJAX request
    function fetchOrders() {
      //var formData = $("#orderReportForm").serialize();
      var orderType = $("#input-order_type").val();
    var startDate = $("#start-date").val();
    var endDate = $("#end-date").val();
    console.log('ENdDate::'+endDate);
      const dictMap = {
        'start_date': startDate,
        'end_date': endDate,
        'order_type': orderType,
      }
      const csrfToken = getCSRFToken();
      $.ajax({
        url: `/admin_dashboard/order_report/`,
        type: "POST",
        data: JSON.stringify(dictMap),
        headers: {
            'X-CSRFToken': csrfToken  // Include the CSRF token in the headers
        },
        contentType: 'application/json',
        success: function(data) {
          // Populate the table with the received data
          data = data.data;
          populateTable(data);
  
          // Calculate and display total orders and order amount
          var totalOrders = data.length;
          var totalAmount = data.reduce(function (acc, order) {
            return acc + order.price;
          }, 0);
  
          $(".total-orders").text("Total Order: " + totalOrders);
          $(".total-amount").text("Total Order Amount: Rs." + totalAmount + "/-");
        },
        error: function(error) {
          console.error("Error fetching orders: ", error);
        }
      });
    }
  
    // Function to handle date and order type changes
    function handleFiltersChange() {
      var startDateString = $("#start-date").val();
  var endDateString = $("#end-date").val();

  // Check if the dates are valid
  var startDate = new Date(startDateString);
  var endDate = new Date(endDateString);

      console.log('endDate::'+endDate);
      if (startDate > endDate) {
        alert("End date must be greater than or equal to start date.");
        return;
      }
  
      // Fetch orders when any of the filters (start date, end date, order type) is changed
      // Only fetch orders if the end date is provided
  if (endDate !== '') {
    fetchOrders();
  }
    }
  
    // Handle start date change
    $("#start-date").change(handleFiltersChange);
  
    // Handle end date change
    $("#end-date").change(handleFiltersChange);
  
    // Handle order type change
    $("#input-order_type").change(handleFiltersChange);
  
    // Function to populate the table with data
    function populateTable(data) {
      var tableBody = $("#orderTable tbody");
  
      // Clear existing table rows
      tableBody.empty();
  
      // Iterate through the data and append rows to the table
      for (var i = 0; i < data.length; i++) {
        var status_order = data[i].order_status;
        var badge = "<span class='badge badge-sm bg-success'>"+status_order+"</span>";
        if (status_order === "Completed")
        {
          badge = "<span class='badge badge-sm bg-success'>"+status_order+"</span>";
        }else if(status_order === "Accepted"){
          badge = "<span class='badge badge-sm bg-primary'>"+status_order+"</span>";
        
        }else if(status_order === "Pick Up Done"){
          badge = "<span class='badge badge-sm bg-primary'>"+status_order+"</span>";
        
        }else if(status_order === "Reached Store"){
          badge = "<span class='badge badge-sm bg-primary'>"+status_order+"</span>";
        }else if(status_order === "Processing"){
          badge = "<span class='badge badge-sm bg-warning'>"+status_order+"</span>";
        }else if(status_order === "Payment Done"){
          badge = "<span class='badge badge-sm bg-info'>"+status_order+"</span>";
        
        }else if(status_order === "Out for Delivery"){
          badge = "<span class='badge badge-sm bg-info'>"+status_order+"</span>";
        }else{
          badge = "<span class='badge badge-sm bg-danger'>"+status_order+"</span>";
        }
        var row = "<tr>" +
                    "<td> <p class='text-xs text-secondary mb-0'>" + data[i].pickup_dt + "</p></td>" +
                    "<td> <p class='text-xs text-secondary mb-0'>" + data[i].orderid + "</p></td>" +
                    "<td> <p class='text-xs text-secondary mb-0'>" + data[i].customer_name + "</p></td>" +
                    "<td> <p class='text-xs text-secondary mb-0'>Rs." + data[i].price + "/-</p></td>" +
                    "<td class='align-middle text-center text-sm'>" + badge + "</td>" +
                  "</tr>";
  
        tableBody.append(row);
      }
    }
  
    // Handle form submission
    $("#orderReportForm").submit(function(e) {
      e.preventDefault();
      
      // Fetch orders on form submission
      fetchOrders();
    });
  
    // Print button click event
    $("#print").click(function() {
      // Remove existing styles
    var printContent = `
      <html>
        <head>
          <style>
            /* General styles */
            body {
              font-family: Arial, sans-serif;
            }

            /* Table styles */
            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
            }
            th, td {
              border: 1px solid #ddd;
              padding: 8px;
              text-align: left;
            }
            th {
              background-color: #343a40;
              color: white;
            }

            /* Print styles */
            @media print {
              body {
                width: 210mm;
                height: 297mm;
                margin: 0 auto;
              }
            }
          </style>
        </head>
        <body>
          <table>
            <thead>
              <tr>
                <th >
                  Date
                </th>
                <th >
                  Order ID
                </th>
                <th >
                  Customer
                </th>
                <th >
                  Order Amount
                </th>
                <th >
                  Status
                </th>
              </tr>
            </thead>
            <tbody>
              ${data.map(order => `
                <tr>
                  <td>${order.pickup_dt}</td>
                  <td>${order.orderid}</td>
                  <td>${order.customer_name}</td>
                  <td>Rs.${order.price}/-</td>
                  <td >${order.order_status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
      </html>`;
      printJS({ printable: printContent, type: 'html', documentTitle: 'Order Report' });
    });
  
    // Download button click event
    $("#download").click(function() {
      // Convert table data to Excel
      var ws = XLSX.utils.table_to_sheet(document.getElementById('orderTable'));
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Order Report');
      XLSX.writeFile(wb, 'order_report.xlsx');
    });
  });
  </script>
  
  <!-- ... your existing HTML code ... -->
  
{% endblock  %}
